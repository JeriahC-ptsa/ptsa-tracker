{% extends "base.html" %}
{% block title %}Add New Measures Â· PTSA Tracker{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <h2 class="mb-0">Create & Assign Measures</h2>
  <a class="btn btn-outline-secondary" href="{{ url_for('admin.companies') }}">Back to Companies</a>
</div>

<div class="alert alert-info" role="status">
    Creating measures for: <strong>{{ company.name }}</strong>
</div>

<form method="POST" action="{{ url_for('admin.company_measures_wizard', company_id=company.id) }}" enctype="multipart/form-data" id="wizard-form" novalidate>

    <div id="measures-container" class="d-grid gap-3">
        <!-- One measure block to start with -->
        <div class="card measure-block" draggable="true">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0 measure-title">Measure 1</h5>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-measure">Delete</button>
                </div>

                <!-- Measure fields -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="m-0-name" class="form-label">Measure name</label>
                        <input id="m-0-name" name="measures[0][name]" class="form-control" required placeholder="e.g., Implement 5S in Toolroom">
                    </div>

                    <div class="col-md-6">
                        <label for="m-0-target" class="form-label">Target / Objective</label>
                        <input id="m-0-target" name="measures[0][target]" class="form-control" placeholder="e.g., Reduce changeover by 20%">
                    </div>

                    <div class="col-12">
                        <label for="m-0-measure_detail" class="form-label">Measure Detail</label>
                        <textarea id="m-0-measure_detail" name="measures[0][measure_detail]" class="form-control" rows="2" placeholder="Short summary"></textarea>
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-departments" class="form-label">Departments</label>
                        <input id="m-0-departments" name="measures[0][departments]" class="form-control" placeholder="e.g., Toolroom, QA">
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-responsible" class="form-label">Responsible</label>
                        <input id="m-0-responsible" name="measures[0][responsible]" class="form-control" placeholder="e.g., Maintenance Lead">
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-participants" class="form-label">Participants</label>
                        <input id="m-0-participants" name="measures[0][participants]" class="form-control" placeholder="Names or teams">
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-urgency" class="form-label">Priority/Urgency</label>
                        <select id="m-0-urgency" name="measures[0][urgency]" class="form-select">
                            <option value="1">Low (1)</option>
                            <option value="2" selected>Normal (2)</option>
                            <option value="3">High (3)</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-start-date" class="form-label">Start Date</label>
                        <input id="m-0-start-date" name="measures[0][start_date]" type="date" class="form-control">
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-end-date" class="form-label">End Date</label>
                        <input id="m-0-end-date" name="measures[0][end_date]" type="date" class="form-control">
                    </div>
                </div>

                <hr>

                <!-- Steps Section -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Procedure</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary add-step">Add Step</button>
                </div>

                <div class="steps-container d-grid gap-2">
                    <!-- Initial step item -->
                    <div class="step-item border rounded p-2">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-12">
                                <label for="m-0-s-0-title" class="form-label">Steps</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input id="m-0-s-0-title" name="measures[0][steps][0][title]" class="form-control" placeholder="e.g., Sort (Seiri)">
                                    <span class="badge bg-primary step-number">Step 1</span>
                                </div>
                            </div>

                            <div class="col-12">
                                <label for="m-0-s-0-file" class="form-label">Add Image (when applicable)</label>
                                <input id="m-0-s-0-file" name="measures[0][steps][0][files][]" type="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg,.webp" multiple>
                            </div>
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-step">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3 d-flex gap-2">
        <button type="button" id="add-measure" class="btn btn-secondary">Add Another Measure</button>
        <button type="submit" class="btn btn-success">Create & Assign Measures</button>
    </div>
</form>

<!-- Hidden templates -->
<template id="tpl-measure">
    <div class="card measure-block">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0 measure-title">Measure</h5>
                <button type="button" class="btn btn-sm btn-outline-danger remove-measure">Delete</button>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Measure name</label>
                    <input class="form-control" required placeholder="e.g., Implement 5S in Toolroom">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Target / Objective</label>
                    <input class="form-control" placeholder="e.g., Reduce changeover by 20%">
                </div>

                <div class="col-12">
                    <label class="form-label">Measure Detail</label>
                    <textarea class="form-control" rows="2" placeholder="Short summary"></textarea>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Departments</label>
                    <input class="form-control" placeholder="e.g., Toolroom, QA">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Responsible</label>
                    <input class="form-control" placeholder="e.g., Maintenance Lead">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Participants</label>
                    <input class="form-control" placeholder="Names or teams">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Priority/Urgency</label>
                    <select class="form-select">
                        <option value="1">Low (1)</option>
                        <option value="2" selected>Normal (2)</option>
                        <option value="3">High (3)</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control">
                </div>

                <div class="col-md-4">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control">
                </div>
            </div>

            <hr>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Procedure</h6>
                <button type="button" class="btn btn-sm btn-outline-primary add-step">Add Step</button>
            </div>

            <div class="steps-container d-grid gap-2">
                <div class="step-item border rounded p-2">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-12">
                            <label class="form-label">Steps</label>
                            <div class="d-flex align-items-center gap-2">
                                <input class="form-control" placeholder="e.g., Set in Order (Seiton)">
                                <span class="badge bg-primary step-number">Step 1</span>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Add Image (when applicable)</label>
                            <input type="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg,.webp" multiple>
                        </div>
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-step">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="tpl-step">
    <div class="step-item border rounded p-2">
        <div class="row g-2 align-items-end">
            <div class="col-md-12">
                <label class="form-label">Steps</label>
                <div class="d-flex align-items-center gap-2">
                    <input class="form-control" placeholder="e.g., Shine (Seiso)">
                    <span class="badge bg-primary step-number">Step</span>
                </div>
            </div>

            <div class="col-12">
                <label class="form-label">Add Image (when applicable)</label>
                <input type="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg,.webp" multiple>
            </div>
            <div class="col-12 text-end">
                <button type="button" class="btn btn-sm btn-outline-danger remove-step">Delete</button>
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('measures-container');
    const addMeasureBtn = document.getElementById('add-measure');
    const tplMeasure = document.getElementById('tpl-measure');
    const tplStep = document.getElementById('tpl-step');

    // Function to update all numbering
    function updateNumbering() {
        // Update measure numbering
        container.querySelectorAll('.measure-block').forEach((block, measureIndex) => {
            const measureNum = measureIndex + 1;
            block.querySelector('.measure-title').textContent = `Measure ${measureNum}`;
            
            // Update measure field names and IDs
            updateMeasureFields(block, measureIndex);
            
            // Update step numbering for this measure
            updateStepNumbering(block, measureIndex);
        });
    }
    
    function updateMeasureFields(block, measureIndex) {
        // Update all form fields with proper names and IDs
        const fieldMap = {
            'input[placeholder*="Implement 5S"]': 'name',
            'input[placeholder*="Reduce changeover"]': 'target',
            'textarea[placeholder*="Short summary"]': 'measure_detail',
            'input[placeholder*="Toolroom, QA"]': 'departments',
            'input[placeholder*="Maintenance Lead"]': 'responsible',
            'input[placeholder*="Names or teams"]': 'participants'
        };
        
        // Update named fields
        Object.entries(fieldMap).forEach(([selector, fieldName]) => {
            const field = block.querySelector(selector);
            if (field) {
                const id = `m-${measureIndex}-${fieldName}`;
                field.id = id;
                field.name = `measures[${measureIndex}][${fieldName}]`;
                
                // Update associated label
                const label = field.closest('.col-md-4, .col-md-6, .col-12')?.querySelector('label');
                if (label) {
                    label.setAttribute('for', id);
                }
            }
        });
        
        // Update urgency select
        const urgencySelect = block.querySelector('select');
        if (urgencySelect) {
            urgencySelect.id = `m-${measureIndex}-urgency`;
            urgencySelect.name = `measures[${measureIndex}][urgency]`;
        }
        
        // Update date fields
        const dateFields = block.querySelectorAll('input[type="date"]');
        dateFields.forEach((field, dateIndex) => {
            const fieldName = dateIndex === 0 ? 'start_date' : 'end_date';
            const id = `m-${measureIndex}-${fieldName}`;
            field.id = id;
            field.name = `measures[${measureIndex}][${fieldName}]`;
            
            const label = field.closest('.col-md-4')?.querySelector('label');
            if (label) {
                label.setAttribute('for', id);
            }
        });
    }
    
    function updateStepNumbering(measureBlock, measureIndex) {
        const stepsContainer = measureBlock.querySelector('.steps-container');
        const steps = stepsContainer.querySelectorAll('.step-item');
        
        steps.forEach((step, stepIndex) => {
            const stepNum = stepIndex + 1;
            
            // Update step number badge
            const badge = step.querySelector('.step-number');
            if (badge) {
                badge.textContent = `Step ${stepNum}`;
            }
            
            // Update step title input
            const titleInput = step.querySelector('input:not([type="file"])');
            if (titleInput) {
                const id = `m-${measureIndex}-s-${stepIndex}-title`;
                titleInput.id = id;
                titleInput.name = `measures[${measureIndex}][steps][${stepIndex}][title]`;
                
                const label = step.querySelector('label:not([for*="file"])');
                if (label) {
                    label.setAttribute('for', id);
                }
            }
            
            // Update file input
            const fileInput = step.querySelector('input[type="file"]');
            if (fileInput) {
                const id = `m-${measureIndex}-s-${stepIndex}-file`;
                fileInput.id = id;
                fileInput.name = `measures[${measureIndex}][steps][${stepIndex}][files][]`;
                
                const label = fileInput.closest('.col-12')?.querySelector('label');
                if (label && label.getAttribute('for') !== id) {
                    label.setAttribute('for', id);
                }
            }
        });
    }

    // Event delegation for all dynamic buttons
    document.addEventListener('click', function(e) {
        // Add step button
        if (e.target.classList.contains('add-step')) {
            e.preventDefault();
            const measureBlock = e.target.closest('.measure-block');
            const stepsContainer = measureBlock.querySelector('.steps-container');
            
            // Clone step template
            const newStep = tplStep.content.cloneNode(true);
            stepsContainer.appendChild(newStep);
            
            // Update numbering after adding
            updateNumbering();
        }
        
        // Remove step button
        else if (e.target.classList.contains('remove-step')) {
            e.preventDefault();
            const step = e.target.closest('.step-item');
            const stepsContainer = step.closest('.steps-container');
            
            // Don't allow removal if it's the last step
            if (stepsContainer.querySelectorAll('.step-item').length <= 1) {
                alert('Each measure must have at least one step.');
                return;
            }
            
            step.remove();
            updateNumbering();
        }
        
        // Remove measure button
        else if (e.target.classList.contains('remove-measure')) {
            e.preventDefault();
            const measureBlock = e.target.closest('.measure-block');
            
            // Don't allow removal if it's the last measure
            if (container.querySelectorAll('.measure-block').length <= 1) {
                alert('You must have at least one measure.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this measure?')) {
                measureBlock.remove();
                updateNumbering();
            }
        }
    });

    // Add new measure button
    addMeasureBtn.addEventListener('click', function() {
        const newMeasure = tplMeasure.content.cloneNode(true);
        container.appendChild(newMeasure);
        updateNumbering();
    });

    // Initial numbering update
    updateNumbering();
    
    // Form validation
    document.getElementById('wizard-form').addEventListener('submit', function(e) {
        let hasErrors = false;
        
        // Check each measure has a name
        container.querySelectorAll('.measure-block').forEach((block, index) => {
            const nameInput = block.querySelector('input[name$="[name]"]');
            if (!nameInput || !nameInput.value.trim()) {
                hasErrors = true;
                nameInput?.classList.add('is-invalid');
                alert(`Measure ${index + 1} must have a name.`);
            } else {
                nameInput.classList.remove('is-invalid');
            }
            
            // Check each measure has at least one step with a title
            const steps = block.querySelectorAll('.step-item');
            let hasValidStep = false;
            steps.forEach(step => {
                const titleInput = step.querySelector('input:not([type="file"])');
                if (titleInput && titleInput.value.trim()) {
                    hasValidStep = true;
                }
            });
            
            if (!hasValidStep) {
                hasErrors = true;
                alert(`Measure ${index + 1} must have at least one step with a title.`);
            }
        });
        
        if (hasErrors) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
                e.dataTransfer.dropEffect = 'move';
                return false;
            });

            step.addEventListener('drop', function(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                if (window._draggedStep && window._draggedStep !== this) {
                    const container = this.parentNode;
                    if (window._draggedStep.parentNode === container) {
                        container.insertBefore(window._draggedStep, this);
                        reindex();
                    }
                }
                return false;
            });
        }

        // Wire drag and drop for measure blocks
        function wireMeasureDragDrop(block) {
            block.addEventListener('dragstart', function(e) {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
                window._draggedMeasure = this;
                this.style.opacity = '0.4';
            });

            block.addEventListener('dragend', function(e) {
                this.style.opacity = '';
                window._draggedMeasure = null;
            });

            block.addEventListener('dragover', function(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            });

            block.addEventListener('drop', function(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                if (window._draggedMeasure && window._draggedMeasure !== this) {
                    container.insertBefore(window._draggedMeasure, this);
                    reindex();
                }
                return false;
            });

            // Wire drag and drop for existing steps
            block.querySelectorAll('.step-item').forEach(wireStepDragDrop);
        }

        // Initialize existing blocks
        container.querySelectorAll('.measure-block').forEach(wireMeasureDragDrop);
        
        // Add measure button
        addMeasureBtn.addEventListener('click', () => {
            const clone = tplMeasure.content.cloneNode(true);
            container.appendChild(clone);
            const newBlock = container.querySelector('.measure-block:last-child');
            wireMeasureDragDrop(newBlock);
            reindex();
        });

        // Add existing measure button
        document.getElementById('add-existing-measure').addEventListener('click', function() {
            alert('Add existing measure: This feature requires backend integration');
        });

        // Initial reindex
        reindex();
    })();
    </script>
{% endblock %}


