{% extends "base.html" %}
{% block title %}{{ company.name }} · Company Profile · PTSA Tracker{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4" data-company-id="{{ company.id }}">
  <div>
    <h2 class="mb-0">{{ company.name }}</h2>
    <p class="text-muted mb-0">Company Profile & Benchmarking</p>
  </div>
  <div>
    <a href="{{ url_for('admin.companies') }}" class="btn btn-outline-secondary me-2">
      <i class="fas fa-arrow-left me-1"></i>Back to Companies
    </a>
    <a href="{{ url_for('admin.edit_company', company_id=company.id) }}" class="btn btn-primary">
      <i class="fas fa-edit me-1"></i>Edit Company
    </a>
  </div>
</div>

<div class="row">
  <!-- Company Information -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-building me-2"></i>Company Information
        </h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label text-muted">Company Name</label>
          <div class="fw-bold">{{ company.name }}</div>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted">Region</label>
          <div>{{ company.region or 'Not specified' }}</div>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted">Industry Category</label>
          <div>{{ company.industry_category or 'Not specified' }}</div>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted">Membership Level</label>
          <div>
            <span class="badge bg-{% if company.membership == 'Platinum' %}warning{% elif company.membership == 'Gold' %}primary{% elif company.membership == 'Silver' %}secondary{% else %}light{% endif %}">
              {{ company.membership or 'Not specified' }}
            </span>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted">Technology Resources</label>
          <div>
            <span class="badge bg-{% if company.tech_resources == 'Advanced' %}success{% elif company.tech_resources == 'Intermediate' %}warning{% else %}info{% endif %}">
              {{ company.tech_resources or 'Not specified' }}
            </span>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted">Human Resources</label>
          <div>{{ company.human_resources or 'Not specified' }}</div>
        </div>
        <div class="mb-3">
          <label class="form-label text-muted">Phone</label>
          <div>{{ company.phone or 'Not specified' }}</div>
        </div>
      </div>
    </div>

    <!-- Active Measures -->
    <div class="card mt-4">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-tasks me-2"></i>Active Measures ({{ assignments|length }})
          </h6>
          <a href="{{ url_for('admin.company_measures_wizard', company_id=company.id) }}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-plus me-1"></i>Assign
          </a>
        </div>
      </div>
      <div class="card-body">
        {% if assignments %}
          {% for assignment in assignments %}
          <div class="assignment-item mb-3 p-3 border rounded">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">{{ assignment.measure.name }}</h6>
                <p class="text-muted mb-2 small">{{ assignment.measure.measure_detail|truncate(80) if assignment.measure.measure_detail else 'No description available' }}</p>
                
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="badge bg-{% if assignment.urgency == 3 %}danger{% elif assignment.urgency == 2 %}warning{% else %}success{% endif %}">
                    Priority {{ assignment.urgency }}
                  </span>
                  <span class="badge bg-{% if assignment.status == 'completed' %}success{% elif assignment.status == 'active' %}primary{% elif assignment.status == 'paused' %}warning{% else %}secondary{% endif %}">
                    {{ assignment.status|title }}
                  </span>
                </div>

                {% if assignment.end_date %}
                <small class="text-muted">Due: {{ assignment.end_date.strftime('%b %d, %Y') }}</small>
                {% endif %}
              </div>
              
              <div class="ms-3">
                <div class="btn-group-vertical">
                  <a href="{{ url_for('admin.view_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-primary mb-1">
                    <i class="fas fa-eye me-1"></i>Details
                  </a>
                  <a href="{{ url_for('admin.measure_profile', measure_id=assignment.measure.id) }}" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-tasks me-1"></i>View Measure
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center py-4">
            <i class="fas fa-tasks fa-2x text-muted mb-3"></i>
            <h6 class="text-muted">No Active Measures</h6>
            <p class="text-muted small">This company has no assigned improvement measures yet.</p>
            <a href="{{ url_for('admin.company_measures_wizard', company_id=company.id) }}" class="btn btn-primary btn-sm">
              <i class="fas fa-plus me-1"></i>Assign First Measure
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Benchmarking Data -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>Company Benchmarking Data
          </h6>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#addBenchmarkModal">
              <i class="fas fa-plus me-1"></i>Add Data
            </button>
            <button type="button" class="btn btn-sm btn-primary" onclick="toggleChartsView()">
              <i class="fas fa-chart-line me-1"></i>View Charts
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        {% if benchmarks %}
          <!-- Benchmarking Table -->
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="table-primary">
                <tr>
                  <th class="benchmark-header-company">{{ company.name }}</th>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <th class="benchmark-header-year">{{ benchmark.data_year }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                <tr class="benchmark-row-turnover">
                  <td class="benchmark-label">Turnover</td>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <td class="benchmark-value">
                    {% if benchmark.turnover %}
                      {{ benchmark.turnover }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                <tr class="benchmark-row-tools">
                  <td class="benchmark-label">Number of tools produced</td>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <td class="benchmark-value">
                    {% if benchmark.tools_produced %}
                      {{ "{:,}".format(benchmark.tools_produced) }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                <tr class="benchmark-row-ontime">
                  <td class="benchmark-label benchmark-label-black">On time delivery</td>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <td class="benchmark-value benchmark-value-black">
                    {% if benchmark.on_time_delivery %}
                      {{ benchmark.on_time_delivery }}%
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                <tr class="benchmark-row-export">
                  <td class="benchmark-label">% of export / T.O.</td>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <td class="benchmark-value">
                    {% if benchmark.export_percentage %}
                      {{ benchmark.export_percentage }}%
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                <tr class="benchmark-row-employees">
                  <td class="benchmark-label">Number of Employees</td>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <td class="benchmark-value">
                    {% if benchmark.employees %}
                      {{ benchmark.employees }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                <tr class="benchmark-row-apprentices">
                  <td class="benchmark-label">Number of Apprentices</td>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <td class="benchmark-value">
                    {% if benchmark.apprentices %}
                      {{ benchmark.apprentices }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                <tr class="benchmark-row-artisans">
                  <td class="benchmark-label">Number of Artisans</td>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <td class="benchmark-value">
                    {% if benchmark.artisans %}
                      {{ benchmark.artisans }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                <tr class="benchmark-row-master-artisans">
                  <td class="benchmark-label benchmark-label-black">Number of Master Artisans</td>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <td class="benchmark-value benchmark-value-black">
                    {% if benchmark.master_artisans %}
                      {{ benchmark.master_artisans }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                <tr class="benchmark-row-engineers">
                  <td class="benchmark-label">Number of Engineers</td>
                  {% for benchmark in benchmarks|sort(attribute='data_year') %}
                  <td class="benchmark-value">
                    {% if benchmark.engineers %}
                      {{ benchmark.engineers }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Notes Section -->
          {% set latest_benchmark = benchmarks|sort(attribute='data_year', reverse=true)|first %}
          {% if latest_benchmark and latest_benchmark.notes %}
          <div class="mt-3">
            <h6 class="text-muted">Latest Notes ({{ latest_benchmark.data_year }})</h6>
            <p class="small">{{ latest_benchmark.notes }}</p>
          </div>
          {% endif %}

        {% else %}
          <!-- No benchmarking data -->
          <div class="text-center py-5">
            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Benchmarking Data</h5>
            <p class="text-muted">Add benchmarking data to track company performance over time.</p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBenchmarkModal">
              <i class="fas fa-plus me-1"></i>Add First Benchmark
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Add Benchmark Modal -->
<div class="modal fade" id="addBenchmarkModal" tabindex="-1" aria-labelledby="addBenchmarkModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addBenchmarkModalLabel">Add Benchmarking Data - {{ company.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="benchmarkForm">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="data_year" class="form-label">Year *</label>
              <input type="number" class="form-control" id="data_year" name="data_year" min="2015" max="2030" value="2024" required>
            </div>
            <div class="col-md-6">
              <label for="turnover" class="form-label">Turnover (Rands)</label>
              <input type="number" class="form-control" id="turnover" name="turnover" step="0.01" placeholder="e.g., 5000000">
            </div>
            <div class="col-md-6">
              <label for="tools_produced" class="form-label">Tools Produced</label>
              <input type="number" class="form-control" id="tools_produced" name="tools_produced" placeholder="e.g., 1500">
            </div>
            <div class="col-md-6">
              <label for="on_time_delivery" class="form-label">On Time Delivery (%)</label>
              <input type="number" class="form-control" id="on_time_delivery" name="on_time_delivery" min="0" max="100" step="0.1" placeholder="e.g., 92.5">
            </div>
            <div class="col-md-6">
              <label for="export_percentage" class="form-label">Export Percentage (%)</label>
              <input type="number" class="form-control" id="export_percentage" name="export_percentage" min="0" max="100" step="0.1" placeholder="e.g., 15.0">
            </div>
            <div class="col-md-6">
              <label for="employees" class="form-label">Total Employees</label>
              <input type="number" class="form-control" id="employees" name="employees" placeholder="e.g., 45">
            </div>
            <div class="col-md-3">
              <label for="apprentices" class="form-label">Apprentices</label>
              <input type="number" class="form-control" id="apprentices" name="apprentices" placeholder="e.g., 3">
            </div>
            <div class="col-md-3">
              <label for="artisans" class="form-label">Artisans</label>
              <input type="number" class="form-control" id="artisans" name="artisans" placeholder="e.g., 18">
            </div>
            <div class="col-md-3">
              <label for="master_artisans" class="form-label">Master Artisans</label>
              <input type="number" class="form-control" id="master_artisans" name="master_artisans" placeholder="e.g., 4">
            </div>
            <div class="col-md-3">
              <label for="engineers" class="form-label">Engineers</label>
              <input type="number" class="form-control" id="engineers" name="engineers" placeholder="e.g., 6">
            </div>
            <div class="col-12">
              <label for="notes" class="form-label">Notes</label>
              <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Additional notes about this year's performance..."></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Benchmarking Data</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Handle benchmark form submission
document.getElementById('benchmarkForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const companyId = parseInt(document.querySelector('[data-company-id]').dataset.companyId);
  
  const data = {
    company_id: companyId,
    data_year: parseInt(formData.get('data_year')),
    turnover: parseFloat(formData.get('turnover')) || null,
    tools_produced: parseInt(formData.get('tools_produced')) || null,
    on_time_delivery: parseFloat(formData.get('on_time_delivery')) || null,
    export_percentage: parseFloat(formData.get('export_percentage')) || null,
    employees: parseInt(formData.get('employees')) || null,
    apprentices: parseInt(formData.get('apprentices')) || null,
    artisans: parseInt(formData.get('artisans')) || null,
    master_artisans: parseInt(formData.get('master_artisans')) || null,
    engineers: parseInt(formData.get('engineers')) || null,
    notes: formData.get('notes') || null
  };
  
  // For now, just show the data (you can implement actual saving later)
  console.log('Benchmark data to save:', data);
  alert('Benchmarking data captured! (Check console for details)\n\nThis would be saved to the database in a full implementation.');
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('addBenchmarkModal'));
  modal.hide();
  
  // Reset form
  this.reset();
});

// Toggle charts view
function toggleChartsView() {
  alert('Charts view would show:\n• Turnover trends over time\n• Production efficiency\n• Employee growth\n• Export percentage changes\n\nThis feature can be implemented with Chart.js or similar library.');
}
</script>
{% endblock %}